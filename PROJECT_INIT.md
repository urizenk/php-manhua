# 项目初始化文档

**仓库状态**: 新建仓库  
**初始化时间**: 2025-11-16  
**项目目录**: php-manhua  

---

## 第一层：核心目标

### 1. 项目核心问题
**漫画资源管理与分享平台**：为漫画爱好者提供一个集中管理、分类展示、访问控制的漫画资源平台。用户可按类型（日更/韩漫/日漫等）浏览资源，管理员通过后台统一管理所有漫画内容。

### 2. 核心功能清单
#### 后台管理系统（管理员端）
- ✅ 添加漫画：按9种类型添加资源（日更板块、韩漫合集、完结短漫、日漫推荐、日漫合集、动漫合集、广播剧合集、失效反馈、防走丢）
- ✅ 漫画列表：增删改查、批量添加/删除、编辑功能（修改标签/状态后自动移动位置）
- ✅ 标签管理：可新增/删除/编辑各类型标签（日期标签、字母标签、作者标签等）
- ✅ 访问码更新：定期更新网站访问码

#### 用户访问界面
- ✅ 主界面：9大功能模块入口（卡片式布局）
- ✅ 访问码验证：点击任意功能模块时提示输入当日访问码
- ✅ 关键词搜索：快速查找漫画资源
- ✅ 详情页展示：
  - 【单集汇总】详情页（奶黄色背景）
  - 【韩漫/日漫/动漫】详情页（横幅图片展示，可调节展示部位）
- ✅ 分页功能：日漫推荐模块每页18本漫画

#### 9大漫画模块特定功能
1. **日更板块**：日期标签排序（最新在上）→资源名称+链接→详情页
2. **韩漫合集**：分类标签→连载/完结分类→详情页
3. **完结短漫**：字母标签（A/B/C）→漫画列表→详情页
4. **日漫推荐**：标签（可编辑/可调位置）→漫画图片展示（18本/页）
5. **日漫合集/动漫合集/广播剧合集/失效反馈/防走丢**：保持硬编码不变

### 3. 整体验收关键标准
| 验收项 | 标准 |
|--------|------|
| **后台管理功能** | 增删改查100%可用、批量操作无误、标签编辑后前台同步更新 |
| **9大模块展示** | 各模块按需求样式正确展示、资源分类准确、链接跳转无误 |
| **访问码验证** | 用户点击功能模块时强制验证、验证通过后正常访问、后台可正常更新访问码 |
| **界面布局** | 后台功能模块左侧竖向排列+下拉子菜单、前台主界面9宫格卡片式布局 |
| **详情页规范** | 【单集汇总】奶黄背景、【韩漫/日漫】横幅图片可调节展示区域 |
| **部署环境** | 可成功部署到宝塔面板、数据库连接正常、访问码功能运行正常 |
| **性能指标** | 页面加载＜3秒、搜索响应＜1秒、支持100+并发用户 |

---

## 第二层：架构与配置

### 1. 技术架构选型

#### 核心技术栈
- **PHP版本**：8.0
- **数据库**：MySQL 5.7.44
- **Web服务器**：Nginx（宝塔默认，高性能）
- **操作系统**：CentOS 7

#### 应用架构模式
- **架构类型**：单体应用（MVC模式）
- **框架选择**：原生PHP + 轻量级路由（考虑服务器资源共享，避免重型框架）
- **前端渲染**：PHP模板引擎（服务端渲染）
- **CSS框架**：Bootstrap 5（轻量、响应式、成熟稳定）
- **JavaScript**：原生JS + jQuery（简化DOM操作）

#### 数据库设计
- **主数据库**：`manhua_db`（存储所有漫画信息、标签、分类、用户数据）
- **访问码配置**：统一存储在主数据库的 `site_config` 表中
- **说明**：您提到的"两个数据库问题"需排查访问码更新时的数据库连接配置路径

### 2. 第三方依赖与服务

#### 必需组件
- **PHP扩展**：
  - `pdo_mysql`（数据库连接）
  - `gd`（图片处理）
  - `mbstring`（中文字符处理）
  - `json`（数据交换）
  - `session`（会话管理）

#### 资源管理
- **文件存储**：本地存储（服务器磁盘，路径：`/www/wwwroot/php-manhua/uploads/`）
- **图片处理**：PHP GD库（缩略图生成、图片裁剪）
- **缓存策略**：文件缓存（避免使用Redis，节省内存资源）
- **外部API**：无（所有资源由管理员手动添加）

### 3. 宝塔部署环境

#### 服务器配置（现有环境）
- **CPU**：2核心
- **内存**：2GB（当前使用617MB）
- **磁盘**：39.25GB总容量（已使用11.69GB）
- **预留资源**：考虑到服务器运行其他项目（已有3个网站），本项目预计占用：
  - 磁盘空间：5-10GB（漫画图片存储）
  - 内存：200-300MB（PHP进程）

#### Web服务配置
- **Web服务器**：Nginx
- **PHP运行模式**：PHP-FPM（宝塔默认）
- **伪静态规则**：需配置（URL美化，如 `/detail/123` 代替 `/detail.php?id=123`）
- **上传限制**：
  - `upload_max_filesize = 50M`（支持批量上传漫画图片）
  - `post_max_size = 50M`
  - `max_execution_time = 300`（批量操作时间）

#### 安全配置
- **SSL证书**：建议配置（宝塔免费Let's Encrypt证书）
- **防跨站攻击**：开启WAF防火墙
- **访问控制**：
  - 管理后台路径隐藏（如 `/admin88/`）
  - 数据库禁止外网访问（仅localhost）
  - 敏感目录禁止直接访问（uploads/仅允许图片访问）

#### 定时任务
- **数据库备份**：每日凌晨3点自动备份（保留最近7天）
- **访问日志清理**：每周清理30天前的日志
- **临时文件清理**：每日清理缓存文件

### 4. 域名与访问配置

- **域名部署**：使用现有域名的子目录或独立子域名
  - 方案A：`https://yourdomain.com/manhua/`（子目录，推荐）
  - 方案B：`https://manhua.yourdomain.com/`（子域名）
- **管理后台路径**：`/admin88/`（自定义路径，提升安全性）
- **伪静态规则**：配置Nginx rewrite规则（隐藏.php后缀）

### 5. 数据库配置问题排查

**关键问题**：您提到"可能有两个数据库导致访问码更新失败"

**解决方案**：
1. 统一使用单一数据库 `manhua_db`
2. 配置文件 `config.php` 中明确数据库连接参数
3. 访问码存储在 `site_config` 表的 `access_code` 字段
4. 更新访问码时检查数据库连接是否正确指向主数据库

**需确认**：
- 当前是否真的有两个数据库？用途分别是什么？
- 访问码更新功能的具体报错信息是什么？

---

## 第三层：模块划分

### 1. 模块清单（按功能边界拆分）

#### 一、核心基础模块（Core）
| 模块编号 | 模块名称 | 核心职责 |
|---------|---------|---------|
| C1 | 数据库管理模块 | 统一数据库连接、查询封装、事务处理 |
| C2 | 路由模块 | URL路由分发、伪静态处理、参数解析 |
| C3 | 会话管理模块 | 访问码验证、Session管理、权限判断 |
| C4 | 文件上传模块 | 图片上传、格式校验、缩略图生成、存储路径管理 |

#### 二、后台管理模块（Admin）
| 模块编号 | 模块名称 | 核心职责 |
|---------|---------|---------|
| A1 | 添加漫画模块 | 按9种类型添加漫画、批量添加、表单验证 |
| A2 | 漫画列表管理模块 | 增删改查、批量操作（删除/修改标签状态）、分页展示（20条/页）、筛选搜索 |
| A3 | 标签管理模块 | 标签CRUD、标签排序、关联检查（删除标签时将漫画移至"未分类"） |
| A4 | 访问码更新模块 | 更新当日访问码、验证规则配置、历史记录查询 |
| A5 | 后台布局模块 | 左侧竖向菜单、下拉子菜单、响应式布局、面包屑导航 |

#### 三、前台展示模块（Frontend）
| 模块编号 | 模块名称 | 核心职责 |
|---------|---------|---------|
| F1 | 主界面模块 | 9宫格卡片展示、访问码拦截（点击模块时验证） |
| F2 | 日更板块模块 | 日期标签管理（最新在上）、资源列表、链接跳转、详情页 |
| F3 | 韩漫合集模块 | 分类标签、连载/完结分类、详情页、状态自动同步 |
| F4 | 完结短漫模块 | 字母标签（A/B/C）、漫画列表、详情页 |
| F5 | 日漫推荐模块 | 标签管理（可编辑/可调位置）、图片网格展示、分页（18本/页） |
| F6 | 固定模块组 | 日漫合集、动漫合集、广播剧合集、失效反馈、防走丢（硬编码） |
| F7 | 搜索模块 | 关键词搜索、模糊匹配、结果高亮 |
| F8 | 详情页模块 | 单集汇总样式（奶黄背景）、韩漫/日漫横幅样式（可调展示区域） |

### 2. 核心模块详细规划

#### ✅ A2-漫画列表管理模块（已确认）

**核心职责**：
- 统一展示所有漫画（跨9种类型），以表格形式呈现
- 支持按类型筛选、按标签筛选、关键词搜索
- 分页展示：**20条/页**
- 单个编辑：修改漫画的类型/标签/状态后，前台自动同步更新位置
- 批量操作：
  - 批量删除
  - **批量修改标签/状态**

**表格显示字段**：
- ID | 缩略图 | 标题 | 所属类型 | 标签 | 状态（连载/完结） | 添加时间 | 操作（编辑/删除）

**与其他模块交互**：
- **→ A1（添加漫画）**：添加成功后自动出现在列表首行
- **→ A3（标签管理）**：删除标签时，关联漫画自动移至"未分类"标签
- **→ F2-F5（前台展示）**：编辑漫画后，前台实时同步（基于数据库查询动态生成）

**数据流**：
```
管理员操作 → 表单提交 → 后端验证 → 数据库更新 → 前台查询时动态读取最新数据
```

#### 📌 A1-添加漫画模块（待确认）

**核心职责**：
- 提供表单，按9种类型添加漫画
- 支持批量添加（如一次添加多个日更资源）
- 上传图片（韩漫/日漫/动漫需要封面图）
- 自动校验：标题、链接、所属类型必填

**关键问题**：
1. **添加流程**：
   - 第一步：选择类型（下拉菜单：日更板块/韩漫合集/...）
   - 第二步：根据类型显示不同表单字段？
     - 例如："日更板块"需填写【日期标签、资源名称、资源链接】
     - 例如："韩漫合集"需填写【分类标签、状态（连载/完结）、封面图、资源名称、资源链接】
   - **您确认不同类型需要不同表单字段吗？**

2. **批量添加方式**：
   - 方案A：表单页面上有"添加一行"按钮，可动态增加多个输入框，一次提交
   - 方案B：支持Excel/CSV导入（管理员上传表格文件，系统批量解析）
   - **您倾向哪个方案？或两个都要？**

3. **图片上传规则**：
   - 哪些类型必须上传封面图？（如：韩漫、日漫、动漫）
   - 哪些类型不需要封面图？（如：日更板块、完结短漫）
   - 图片格式限制：JPG/PNG/WEBP？
   - 图片大小限制：单张最大多少MB？

4. **与其他模块交互**：
   - **→ A3（标签管理）**：添加漫画时，标签是从A3模块创建的标签列表中选择？还是可以在添加时新建标签？

#### ✅ A1-添加漫画模块（方案确定）

**表单字段策略**：根据类型动态显示不同字段
- 日更板块：日期标签 + 资源名称 + 资源链接
- 韩漫合集：分类标签 + 连载/完结状态 + 封面图 + 漫画名称 + 资源链接
- 完结短漫：字母标签 + 漫画名称 + 资源链接
- 日漫推荐：作者标签 + 封面图 + 漫画名称 + 资源链接

**批量添加**：方案A（动态添加行）+ 方案B（Excel导入）
**图片上传**：韩漫/日漫/动漫类型需封面图，格式JPG/PNG/WEBP，单张最大5MB
**标签管理**：方案B（可选现有标签或添加时新建标签）

#### ✅ F1-主界面模块 & F8-详情页模块（方案确定）

**F1主界面**：
- 9宫格卡片布局（Bootstrap卡片组件）
- 用户点击任意卡片时，弹窗提示输入访问码
- 验证通过后跳转到对应模块页面

**F8详情页**：
- 单集汇总样式：奶黄色背景（#FFF8DC）
- 韩漫/日漫详情页：横幅图片展示（可通过CSS调节object-position）

### 3. 模块间交互关系图

```
[C1-数据库] ←→ 所有模块
[C2-路由] ←→ 所有HTTP请求
[C3-会话] ←→ F1/A1-A5
[C4-上传] ←→ A1

[A1-添加] → [A2-列表] → [A3-标签]
[A1-添加] → [F2-F8前台展示]
[A3-标签] → [A2-列表]（删除标签时移至"未分类"）

[F1-主界面] → [C3-会话]（访问码验证）→ [F2-F8]
[F7-搜索] → [F2-F8]（跨模块搜索）
```

---

## 第四层：迭代与管理

### 1. 迭代计划

**迭代策略**：按模块优先级分3轮迭代

| 迭代轮次 | 周期 | 核心任务 | 里程碑 |
|---------|------|---------|--------|
| **第1轮** | 3天 | 核心基础模块（C1-C4）+ 数据库设计 | 数据库表结构完成、基础框架搭建完成 |
| **第2轮** | 5天 | 后台管理模块（A1-A5） | 后台管理系统可用、能添加/管理漫画 |
| **第3轮** | 4天 | 前台展示模块（F1-F8） | 前台展示完整、访问码验证正常、全功能可用 |

**总工期**：12天（可根据实际进度调整）

### 2. 分支管理策略

- **主分支**：`main`（生产环境代码，仅合并已验收代码）
- **开发分支**：`develop`（开发环境，日常开发合并目标）
- **功能分支**：`feature/[模块名]`（如 `feature/admin-manga-list`）

**工作流程**：
```
develop → feature/模块名 → 开发 → 测试 → 合并回develop → 验收通过 → 合并至main
```

### 3. Commit规范

格式：`[模块编号]-[功能]：具体修改`

示例：
- `[C1]-数据库：创建漫画表结构`
- `[A2]-列表：实现分页功能`
- `[F1]-主界面：完成9宫格布局`

### 4. 关键里程碑

| 里程碑 | 验收标准 | 预计完成时间 |
|--------|---------|-------------|
| 数据库设计完成 | 所有表结构创建、索引优化、测试数据导入 | Day 1 |
| 基础框架完成 | 路由/数据库/会话/上传模块正常运行 | Day 3 |
| 后台管理可用 | 能添加/编辑/删除漫画，标签管理正常 | Day 8 |
| 前台展示完成 | 9大模块展示正常，访问码验证通过 | Day 11 |
| 全功能验收通过 | 所有功能测试通过，部署到宝塔成功 | Day 12 |

### 5. 配置备份策略

**备份内容**：
- 数据库：每日凌晨3点自动备份（保留7天）
- 配置文件：`config/config.php`、`.env`（版本命名：`config_v1.0_20251116`）
- 上传文件：每周备份至 `./backup/uploads/`

**备份路径**：`/www/backup/php-manhua/`

### 6. 测试覆盖要求

**测试点**：
- 功能测试：所有增删改查操作
- 边界测试：空值、超长字符、特殊字符
- 安全测试：SQL注入、XSS攻击、访问码绕过
- 性能测试：并发100用户、页面加载时间

**最低覆盖率**：核心功能测试覆盖率≥90%

---

## 最终验收标准

### 功能验收标准

| 验收项 | 具体标准 | 验收方法 |
|--------|---------|---------|
| 后台管理 | 增删改查100%可用、批量操作无误 | 手动测试所有操作 |
| 9大模块展示 | 各模块样式符合需求截图、链接跳转正确 | 逐一对比需求截图 |
| 访问码验证 | 点击功能模块强制验证、错误码拦截、正确码放行 | 测试正确/错误/空码 |
| 搜索功能 | 关键词模糊匹配、结果准确 | 测试10+关键词 |
| 详情页 | 单集汇总奶黄背景、横幅图片正确展示 | 视觉验收 |
| 数据库问题 | 访问码更新功能正常、无"两个数据库"冲突 | 更新访问码并前台验证 |

### 性能验收标准

- 页面加载：首页＜2秒、列表页＜3秒
- 搜索响应：＜1秒
- 并发支持：100+用户同时访问不卡顿

### 部署验收标准

- 成功部署到宝塔面板
- Nginx配置正确、伪静态生效
- 数据库连接正常、访问码功能运行正常
- SSL证书配置完成（如需要）

**✅ 项目初始化完成，所有4层信息已确认无遗漏**

